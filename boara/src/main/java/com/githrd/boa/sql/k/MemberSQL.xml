<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
			"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
			
<!-- 

 이 클래스는 회원관련 질의명령을 기억하고 
 필요한 순간에 반환해주는 클래스
 
  @author	김소연
  @since	2022.06.
  @version	v.1.0
  
  			작업이력 ]
  				2022.06.13	-	담당자 ] 김소연
 								클래스제작, 로그인
 				2022.06.16  - 	id, pw 찾기, 조회수 TOP
 				2022.06.18  -	회원정보보기
 				2022.06.21	-	탈퇴 
 				2022.06.23 	-	회원가입
 				2022.06.23	-	회원정보수정(+프로필 이미지 변경)
  									
 
  -->
<mapper namespace="mSQL">

	<!-- 멤버 테이블에서 COUNT 조회 재사용 -->
	<sql id="selCnt">
		SELECT
			COUNT(*)
		FROM
			member
		WHERE
	</sql>
	
	<!-- 로그인 처리  -->
	<select id="login" resultType="int" parameterType="mVO">
		<include refid="selCnt" />
			id = #{id}
			AND isshow = 'Y'
			AND pw = #{pw}
	</select>
	<!-- 회원가입시 중복체크항목 -->
	<select id="idCnt" resultType="int" parameterType="String">
		<include refid="selCnt" />
			id = #{id}
	</select>
	
	<select id="mailCnt" resultType="int" parameterType="String">
		<include refid="selCnt" />
			mail = #{mail}
	</select>
	
	<select id="telCnt" resultType="int" parameterType="String">
		<include refid="selCnt" />
			tel = #{tel}
	</select>
	
	<insert id="join" parameterType="mVO">
		<selectKey keyProperty="mno" resultType="int" order="BEFORE">
			SELECT
				NVL(MAX(mno)+1, 1001)
			FROM
				member
		</selectKey>
		
		INSERT INTO
			member(mno ,id, pw, name, mail, tel)
		VALUES(
			#{mno}, #{id}, #{pw}, #{name}, #{mail}, #{tel}
		)
		
	</insert>
	
	<insert id="joinimg" parameterType="fVO">
		<selectKey keyProperty="fno" resultType="int" order="BEFORE">
			SELECT
				NVL(MAX(fno) + 1, 100001)
			FROM
				imgfile
		</selectKey>
		
		INSERT INTO
			imgfile(fno, mno, oriname, savename, len, isshow, whereis )
		VALUES(
			#{fno}, #{mno}, #{oriname}, #{savename}, #{len}, 'C', 'M'
		)
	</insert>
	
	
	<!-- 회원가입 100포인트  -->
    <insert id="addPoint" parameterType="mVO">  
		INSERT INTO
		    point(pno, mno, gnp, pcode, sumpoint)
		VALUES(
		        (
		        SELECT
		              NVL(MAX(pno)+1, 1000000001) 
		        FROM
		             point
		         ) 
		        , 
		        (
		         SELECT
		              NVL(MAX(mno), 1001) 
		        FROM
		             member
		        ) 
		        , 100, 110, 100)
	</insert>	

		
	<select id="idSeacch" resultType="String" parameterType="mVO">
	SELECT
		id
	FROM
		member
	WHERE
		name= #{name}
		AND tel = #{tel}
	</select>
	
	<select id="pwSeacch" resultType="String" parameterType="mVO">
	SELECT
		pw
	FROM
		member
	WHERE
		id= #{id}
		AND mail = #{mail}
	</select>
	
	
<!-- 	
	today 조회수 top5
	<select id="topBoard" resultTUpe="bVO" >
	SELECT
    *
	FROM
	    (
	        SELECT
	            bno, title, body, wdate
	        FROM
	            board
	        ORDER BY 
	            click DESC
	    )
	WHERE 
	    ROWNUM <= 5
	    AND wdate >= (sysdate-7)
	</select>

 -->
 
 
 	<!-- 회원정보 수정시 불러올 데이터 -->
 	
 	<select id="getIdInfo" resultType="mVO" parameterType="String">
 		SELECT
		    mno, name, id, pw, mail, tel
        FROM
		    member 
		WHERE
		    isshow = 'Y'
		    AND id = #{id}
 	</select>
 
 	
 	<select id="getIdImg" resultType="fVO" parameterType="string">
 		SELECT
            fno, savename
    	FROM
       		imgfile f, member m
	    WHERE
	        f.isshow = 'C'
	        AND f.whereis = 'M'
	        AND f.mno = m.mno
	        AND id = #{id}
 	</select>
 	
 	<update id="delImg" parameterType="int">
		UPDATE
		    imgfile
		SET
		    isshow = 'N'
		WHERE
		    fno = #{fno}
		   
 	</update>
 	
 	<update id="editInfo" parameterType="mVO">
 		UPDATE
 			member
 		<set>
 			<if test="mail neq null">
 				mail = #{mail},
 			</if>
 			<if test="tel neq null">
 				tel = #{tel},
 			</if>
 			<if test="pw neq null">
 				pw = #{pw},
 			</if>
 		</set>
 		WHERE
 			mno = (
 				SELECT
 					mno
 				FROM
 					member
 				WHERE
 					id= #{id}
 				
 			)
 	</update>
 	
 
 	<!-- 탈퇴 처리 -->
 	<select id="delMember" parameterType="mVO">
 		UPDATE
 			member
 		SET
 			isshow = 'N'
 		WHERE
 			isshow IN('Y','N')
 			AND id = #{id}
 			AND pw = #{pw}
 	</select>
</mapper>