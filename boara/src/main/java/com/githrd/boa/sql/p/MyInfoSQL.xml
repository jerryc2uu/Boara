<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
			"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="iSQL">
	<!-- 마이페이지 메인 폼보기 (가입일, 게시글, 댓글, 총 포인트) -->
	<select id="getMyInfo" resultType="iVO" parameterType="string">
		SELECT
		    m.jdate jdate, i.savename savename, p.sumpoint,
		    (
		        SELECT
		            COUNT(*)
		        FROM
		            reply
		        WHERE
		            mno = (SELECT
		                        mno
		                    FROM
		                        member
		                    WHERE
		                        id = #{id}) 
		    ) rcnt,
		    (
		        SELECT
		            COUNT(*)
		        FROM
		            board        
		        WHERE
		            mno = (SELECT
		                        mno
		                    FROM
		                        member
		                    WHERE
		                        id = #{id})
		    ) bcnt
		    
		FROM
		    member m, imgfile i, point p
		WHERE
		    id = #{id}
		    AND m.mno = i.mno
		    AND i.isshow = 'C'
		    AND i.whereis = 'M'
		    AND m.mno = p.mno
		    AND pdate = (
		                    SELECT
		                        MAX(pdate)
		                    FROM
		                        point
		                    WHERE
		                        mno = (SELECT
		                                    mno
		                                FROM
		                                    member
		                                WHERE
		                                    id = #{id})
		                )
	</select>	
	
	<!-- 구매글 수 조회 -->
	<select id="myBuyCount" resultType="int" parameterType="string">
		SELECT
		    COUNT(pno)
		FROM
		    point p
		WHERE
		    pcode = 201
		    AND p.mno = (SELECT mno FROM member WHERE id = #{id})
	</select>
	<!-- 나의 구매글 리스트 조회 -->
	<select id="myBuyList" resultType="iVO" parameterType="iVO">
		SELECT
		    bno, cname, id, title, sdate, price 
		FROM
		    (
		    SELECT
		        ROWNUM rno, bno, cname, id, title, sdate, price
		    FROM
		        (
		        SELECT
		            bno, cname, id, title, TO_CHAR(wdate, 'yyyy/MM/dd') sdate, price
		        FROM
		            member m, board b, collection c
		        WHERE
		            m.mno = b.mno
		            AND b.cno = c.cno
		            AND bno IN (
		                    SELECT
		                        bno
		                    FROM
		                        point p
		                    WHERE
		                        pcode = 201
		                        AND p.mno = (SELECT mno FROM member WHERE id = #{id})
		                    )
		        )
		    )
		WHERE
		    rno BETWEEN #{startCont} AND #{endCont}
	</select>
	<!-- 포인트 내역 갯수 -->
	<select id="myPointCnt" resultType="int" parameterType="string">
		SELECT
		    COUNT(pno)
		FROM
		    point
		WHERE
		    mno = (
		            SELECT
		                mno
		            FROM
		                member
		            WHERE
		                id = #{id}
		            )
	</select>
	<!-- 포인트 내역 조회-->
	<select id="myPoint" resultType="iVO" parameterType="iVO">
		SELECT
		    pno, gnp, sdate, pcode, detail
		FROM
		    (
		    SELECT
		        ROWNUM rno, pno, gnp, sdate, pcode, detail
		    FROM
		        (
		        SELECT
		            pno, p.gnp gnp, TO_CHAR(p.pdate, 'yyyy/MM/dd') sdate, p.pcode pcode, detail
		        FROM
		            point p, detailcode d
		        WHERE   
		            p.pcode = d.pcode
		            AND mno = (
		                    SELECT
		                        mno
		                    FROM
		                        member
		                    WHERE
		                        id = #{id}
		                    )
		        ORDER BY
		            pno DESC
		        )
		    )
		WHERE
		    rno BETWEEN #{startCont} AND #{endCont}
	</select>
	<!-- 좋아요 갯수 -->
	<select id="myLikeCnt" resultType="int" parameterType="string">
		SELECT
		    COUNT(MKNO)
		FROM
		    mark
		WHERE
		     mno = (
		            SELECT
		                mno
		            FROM
		                member
		            WHERE
		                id = #{id}
		            )
		     AND isshow = 'L'
	</select>
	<!-- 좋아요 리스트 조회 -->
	<select id="myLike" resultType="iVO" parameterType="iVO">
		SELECT
		    bno, cname, id, title, sdate, click 
		FROM
		    (
		    SELECT
		        ROWNUM rno, bno, cname, id, title, sdate, click 
		    FROM
		        (
		        SELECT
		            bno, cname, id, title, TO_CHAR(wdate, 'yyyy/MM/dd') sdate, click 
		        FROM
		            member m, board b, collection c
		        WHERE
		            m.mno = b.mno
		            AND b.cno = c.cno
		            AND bno IN (
		                        SELECT
		                            bno
		                        FROM
		                            mark
		                        WHERE
		                            mno = (
		                                    SELECT
		                                        mno
		                                    FROM
		                                        member
		                                    WHERE
		                                        id = #{id}
		                                    )
		                            AND isshow = 'L'
		                        )
		        )
		    )
		WHERE
		    rno BETWEEN #{startCont} AND #{endCont}
	</select>
	<!-- 찜 갯수 조회 -->
	<select id="myJJimCnt" resultType="int" parameterType="string">
		SELECT
		    COUNT(MKNO)
		FROM
		    mark
		WHERE
		     mno = (
		            SELECT
		                mno
		            FROM
		                member
		            WHERE
		                id = #{id}
		            )
		    AND isshow = 'J'
	</select>
	<!-- 찜 목록 조회 -->
	<select id="myJJim" resultType="iVO" parameterType="iVO">
		SELECT
		    bno, cname, id, title, sdate, click 
		FROM
		    (
		    SELECT
		        ROWNUM rno, bno, cname, id, title, sdate, click 
		    FROM
		        (
		        SELECT
		            bno, cname, id, title, TO_CHAR(wdate, 'yyyy/MM/dd') sdate, click 
		        FROM
		            member m, board b, collection c
		        WHERE
		            m.mno = b.mno
		            AND b.cno = c.cno
		            AND bno IN (
		                        SELECT
		                            bno
		                        FROM
		                            mark
		                        WHERE
		                            mno = (
		                                    SELECT
		                                        mno
		                                    FROM
		                                        member
		                                    WHERE
		                                        id = #{id}
		                                    )
		                            AND isshow = 'J'
		                        )
		        )
		    )
		WHERE
		    rno BETWEEN #{startCont} AND #{endCont}
	</select>
	
	<!-- 내가 작성한 게시글 갯수 -->
	<select id="myBoardCnt" resultType="int" parameterType="string">
		SELECT
		    COUNT(bno)
		FROM
		    board
		WHERE
		    mno = (
		            SELECT
		                mno
		            FROM
		                member
		            WHERE
		                id = #{id}
		            )
	</select>
	<!-- 내가 작성한 게시글 목록 -->
	<select id="myBoard" resultType="iVO" parameterType="iVO">
		SELECT
		    bno, cname, title, sdate, click, hno           
		FROM
		    (
		    SELECT
		        ROWNUM rno, bno, cname, title, sdate, click, hno
		    FROM
		        (
		        SELECT
		            b.bno, cname, b.title title, TO_CHAR(wdate, 'yyyy/MM/dd') sdate, click, h.hno hno   
		        FROM
		            board b, collection c, hot h
		        WHERE
		            b.cno = c.cno
		            AND h.bno(+) = b.bno
		            AND h.hend(+) > sysdate
		            AND b.mno = (
		                    SELECT
		                        mno
		                    FROM
		                        member
		                    WHERE
		                        id = #{id}
		                    )
		        ORDER BY
		            wdate DESC
		        )
		    )
		WHERE
		    rno BETWEEN #{startCont} AND #{endCont}
	</select>
	<!-- 내가 작성한 댓글 갯수 -->
	<select id="myReboardCnt" resultType="int" parameterType="string">
		SELECT
		    COUNT(rno)
		FROM
		    reply
		WHERE
		    mno = (
		            SELECT
		                mno
		            FROM
		                member
		            WHERE
		                id = 'psoy'
		            )
		    AND isshow IN ('Y', 'S')
	</select>
	<!-- 내가 작성한 댓글 목록 -->
	<select id="myReboard" resultType="iVO" parameterType="iVO">
		SELECT
		    rno, body, bno, sdate, title
		FROM
		    (
		    SELECT
		        ROWNUM rowno, rno, body, bno, sdate, title
		    FROM
		        (
		            SELECT
		                rno, r.body body, r.bno bno, TO_CHAR(rdate, 'yyyy/MM/dd') sdate, b.title title
		            FROM
		                reply r, board b
		            WHERE
		                r.bno = b.bno
		                AND r.mno = (
		                            SELECT
		                                mno
		                            FROM
		                                member
		                            WHERE
		                                id = #{id}
		                            )
		                AND r.isshow IN ('Y', 'S')
		            )
		        )
		WHERE   
		    rowno BETWEEN #{startCont} AND #{endCont}
	</select>
	
	<!-- 포인트 충전 폼보기 -->
	<select id="addPoint" resultType="iVO" parameterType="iVO">
		SELECT
		    sumpoint
		FROM
		    point
		WHERE
		    (
		    SELECT
		        MAX(pno)
		    FROM
		        point
		    WHERE
		        mno = (
		            SELECT
		                mno
		            FROM
		                member
		            WHERE
		                id = #{id}
		            )
		    ) = pno
	</select>
	<!-- 포인트 충전 -->
	<insert id="addPointProc" parameterType="iVO">
		INSERT INTO
		    point(pno, mno, gnp, pcode, sumpoint)
		VALUES(
		    (SELECT
		        NVL(MAX(pno) + 1, 1000000001) 
		     FROM
		        point),
		    (
		    SELECT
		        mno
		    FROM
		        member
		    WHERE
		        id = #{id}
		    ), #{gnp}, 101, 
		        (SELECT
		            sumpoint
		        FROM
		            point
		        WHERE
		            (
		            SELECT
		                MAX(pno)
		            FROM
		                point
		            WHERE
		                mno = (
		                    SELECT
		                        mno
		                    FROM
		                        member
		                    WHERE
		                        id = #{id}
		                    )
		            ) = pno) + #{gnp}
		)
	</insert>
</mapper>